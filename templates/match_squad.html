{% extends 'base.html' %}
{% load static %}
{% block 'main' %}
{% csrf_token %}

<div class="site-section bg-dark">
    <div class="container">
        <div class="row mt-3 justify-content-evenly">
            <h1 id="scorecard-entry-header">Match Squad Selection</h1>
        </div>

        <form id="scorecardForm" method="POST" action="{% url 'match_squad' %}">
            {% csrf_token %}
            <div class="row mt-3">
                <div class="col-md-6">
                    <label for="match">Select Match</label>
                    <select class="form-select" name="match" id="match" required onchange="chkmatch()">
                        <option value="">---Select Match---</option>
                        {% for match in matches %}
                        <option value="{{ match.match_id }}">{{ match }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <div class="row w-100 mt-4">
                <div class="col-md-6">
                    <h3 id="t1_name">Team 1 Players</h3>
                    <table class="table custom-table">
                        <thead>
                            <tr>
                                <th>Select</th>
                                <th>Is Playing</th>
                                <th>Player Name</th>
                            </tr>
                        </thead>
                        <tbody id="team1_players"></tbody>
                    </table>
                </div>

                <div class="col-md-6">
                    <h3 id="t2_name">Team 2 Players</h3>
                    <table class="table custom-table">
                        <thead>
                            <tr>
                                <th>Select</th>
                                <th>Is Playing</th>
                                <th>Player Name</th>
                            </tr>
                        </thead>
                        <tbody id="team2_players"></tbody>
                    </table>
                </div>
            </div>

            <div class="mt-3">
                <button type="button" class="btn btn-primary" onclick="chksave()">Save Squad</button>
            </div>
        </form>

    </div>
</div>
<script>
    let team1, team2;
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    function chkmatch() {
        var mid = document.getElementById("match").value;
        console.log("MID", mid);
        var chkmatch = 'chkmatch';

        $.ajax({
            url: 'match_squad',
            type: 'POST',
            headers: { 'X-CSRFToken': csrftoken },
            data: { "mid": mid, "chkmatch": chkmatch },
            success: function (response) {
                if ((response) == "Match Not Found" || (response) == "Match Already Exist") {
                    alert(response);
                    document.getElementById('match').value = '';
                }
                else {
                    teams = response["teams"];
                    t1_players = response["team1_players"];
                    t2_players = response["team2_players"];
                    console.log(response);
                    console.log(t1_players);
                    console.log(t2_players);
                    team1 = teams[0][1];
                    team2 = teams[1][1];

                    document.getElementById("t1_name").innerText = `${team1} Players`;
                    document.getElementById("t2_name").innerText = `${team2} Players`;

                    let table1 = document.getElementById("team1_players").id;
                    fillPlayerTable(table1, t1_players)
                    let table2 = document.getElementById("team2_players").id;
                    fillPlayerTable(table2, t2_players)


                }

            },
            error: function (error) {
                alert(error);
            }
        });



    }

    function fillPlayerTable(tableId, players) {
        console.log("Filling table:", tableId, players);


        const tbody = $('#' + tableId);
        tbody.empty();

        let count = 0;

        players.forEach(function (player, index) {
            const pid = player.pid;
            const pname = player.pname;

            const row = `
            <tr>
                <td>
                    <input type="checkbox" name="${tableId}_player" 
                           id="${tableId}_player_${count}" 
                           value="${pid}">
                </td>
                <td>
                    <input type="checkbox" name="${tableId}_is_playing" 
                           id="${tableId}_is_playing_${count}">
                </td>
                <td>
                    <label for="${tableId}_player_${count}">${pname}</label>
                </td>
            </tr>
        `;

            tbody.append(row);
            count += 1;
        });
    }

    function chksave() {
        let msave = "S";
        var mid = document.getElementById("match").value;
        if (!mid) {
            alert("Please select a match.");
            return;
        }

        var playerlist = [];

        [
            { tableId: 'team1_players', team: team1 },
            { tableId: 'team2_players', team: team2 }
        ].forEach(function (tableInfo) {
            const table = document.getElementById(tableInfo.tableId);
            const rows = table.getElementsByTagName("tr");

            for (let i = 0; i < rows.length; i++) {
                const row = rows[i];
                const inputs = row.getElementsByTagName("input");
                const label = row.getElementsByTagName("label")[0];

                let selected = false;
                let pid = null;
                let is_playing = false;
                let pname = label ? label.innerText : "";

                for (let input of inputs) {
                    if (input.name.includes("_player") && input.checked) {
                        console.log("selected");
                        selected = true;
                        pid = input.value;
                    }
                    if (input.name.includes("_is_playing")) {
                        is_playing = input.checked;
                    }
                }

                if (selected && pid) {
                    playerlist.push([is_playing, pname, tableInfo.team]);
                }
            }
        });

        console.log("Prepared Player List:", playerlist);

        $.ajax({
            url: 'match_squad',
            type: 'POST',
            headers: { 'X-CSRFToken': csrftoken },
            data: {
                "mid": mid,
                "msave": msave,
                "players": JSON.stringify(playerlist)
            },
            success: function (response) {
                if (response.error) {
                    alert(response.error);
                } else if (response.message) {
                    alert(response.message);
                    window.location.href = '/admin_dashboard';
                } else {
                    alert("Unexpected response");
                }


            },
            error: function (error) {
                alert("Error saving squad.");
                console.error(error);
            }
        });
    }

</script>
{% endblock 'main' %}