{% extends 'base.html' %}
{% load static %}
{% block 'main' %}
{% csrf_token %}
<style>
    /* Your style for #match remains unchanged */
    #match {
        white-space: nowrap;
        overflow: hidden; 
        text-overflow: ellipsis;
        width: 100%; 
    }
</style>

<div class="site-section bg-dark">
    <div class="container">
        <div class="row mt-3 justify-content-evenly">
            <h1 id="scorecard-entry-header" style="margin-top: 50px;">Match Squad Selection</h1>
        </div>

        <form id="scorecardForm" method="POST" action="{% url 'match_squad' %}">
            {% csrf_token %}
            
            <div class="row mt-3 justify-content-center">
                <div class="col-12 col-lg-8 col-xl-6 text-center">
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="squadMode" id="modeAdd" value="add" checked>
                        <label class="form-check-label" for="modeAdd">Add New Squad</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="squadMode" id="modeUpdate" value="update">
                        <label class="form-check-label" for="modeUpdate">Update Existing Squad</label>
                    </div>
                </div>
            </div>

            <div class="row mt-3 justify-content-center">
                <div class="col-12 col-lg-8 col-xl-6">
                    <label for="match">Select Match</label>
                    <select class="form-select" name="match" id="match" required onchange="chkmatch()">
                        </select>
                </div>
            </div>

            <div class="row w-100 mt-4">
                <div class="col-md-6">
                    <h3 id="t1_name">Team 1 Players</h3>
                    <table class="table custom-table">
                        <thead>
                            <tr>
                                <th>Select</th>
                                <th>Is Playing</th>
                                <th>Player Name</th>
                            </tr>
                        </thead>
                        <tbody id="team1_players"></tbody>
                    </table>
                </div>

                <div class="col-md-6">
                    <h3 id="t2_name">Team 2 Players</h3>
                    <table class="table custom-table">
                        <thead>
                            <tr>
                                <th>Select</th>
                                <th>Is Playing</th>
                                <th>Player Name</th>
                            </tr>
                        </thead>
                        <tbody id="team2_players"></tbody>
                    </table>
                </div>
            </div>

            <div class="mt-3">
                <button type="button" class="btn btn-primary" onclick="chksave()">Save Squad</button>
            </div>
        </form>

    </div>
</div>
<script>
    // --- NEW: Storing matches from Django context ---
    const inactiveMatches = [
        {% for match in inactive_matches %}
        { id: '{{ match.match_id }}', text: '{{ match }}' },
        {% endfor %}
    ];
    const activeMatches = [
        {% for match in active_matches %}
        { id: '{{ match.match_id }}', text: '{{ match }}' },
        {% endfor %}
    ];

    let team1, team2;
    const csrftoken = getCookie('csrftoken'); // Assumes getCookie function is present

    // --- NEW: Run on page load ---
    document.addEventListener('DOMContentLoaded', function() {
        // Set initial mode and populate dropdown
        updateMatchDropdown();

        // Add listeners to radio buttons
        document.getElementById('modeAdd').addEventListener('change', updateMatchDropdown);
        document.getElementById('modeUpdate').addEventListener('change', updateMatchDropdown);
    });

    // --- NEW: Function to update dropdown based on mode ---
    function updateMatchDropdown() {
        const mode = document.querySelector('input[name="squadMode"]:checked').value;
        const matchSelect = document.getElementById('match');
        const matches = (mode === 'add') ? inactiveMatches : activeMatches;

        // Clear existing options and tables
        matchSelect.innerHTML = '';
        $('#team1_players').empty();
        $('#team2_players').empty();
        $('#t1_name').text('Team 1 Players');
        $('#t2_name').text('Team 2 Players');


        // Add default option
        matchSelect.add(new Option('---Select Match---', ''));

        // Populate with new options
        matches.forEach(function(match) {
            matchSelect.add(new Option(match.text, match.id));
        });
    }

    // --- getCookie function (unchanged) ---
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // --- MODIFIED: chkmatch() ---
    function chkmatch() {
        var mid = document.getElementById("match").value;
        
        // Clear tables if user selects default
        if (!mid) { 
            $('#team1_players').empty();
            $('#team2_players').empty();
            $('#t1_name').text('Team 1 Players');
            $('#t2_name').text('Team 2 Players');
            return;
        }

        var mode = document.querySelector('input[name="squadMode"]:checked').value; // Get current mode
        var chkmatch = 'chkmatch';

        $.ajax({
            url: 'match_squad',
            type: 'POST',
            headers: { 'X-CSRFToken': csrftoken },
            data: { "mid": mid, "chkmatch": chkmatch, "mode": mode }, // Send mode
            success: function (response) {
                // MODIFIED: Handle JSON error response
                if (response.error) {
                    alert(response.error);
                    document.getElementById('match').value = '';
                    // Clear tables on error
                    $('#team1_players').empty();
                    $('#team2_players').empty();
                    $('#t1_name').text('Team 1 Players');
                    $('#t2_name').text('Team 2 Players');
                }
                else {
                    teams = response["teams"];
                    t1_players = response["team1_players"];
                    t2_players = response["team2_players"];
                    // NEW: Get existing squad data (will be {} in 'add' mode)
                    let existing_squad = response.existing_squad || {}; 

                    console.log("Existing Squad:", existing_squad);

                    team1 = teams[0][1];
                    team2 = teams[1][1];

                    document.getElementById("t1_name").innerText = `${team1} Players`;
                    document.getElementById("t2_name").innerText = `${team2} Players`;

                    let table1 = document.getElementById("team1_players").id;
                    // MODIFIED: Pass existing_squad to fillPlayerTable
                    fillPlayerTable(table1, t1_players, existing_squad) 
                    let table2 = document.getElementById("team2_players").id;
                    fillPlayerTable(table2, t2_players, existing_squad)
                }
            },
            error: function (xhr, status, error) {
                // Improved error logging
                let errorMsg = "An unknown error occurred.";
                if (xhr.responseJSON && xhr.responseJSON.error) {
                    errorMsg = xhr.responseJSON.error;
                } else if (xhr.responseText) {
                    try {
                        errorMsg = JSON.parse(xhr.responseText).error;
                    } catch (e) {
                        errorMsg = xhr.responseText;
                    }
                }
                alert("Error: " + errorMsg);
                console.error(xhr.responseText);
            }
        });
    }

    // --- MODIFIED: fillPlayerTable() ---
    // Now accepts `existing_squad` to pre-check boxes
    function fillPlayerTable(tableId, players, existing_squad) {
        console.log("Filling table:", tableId, players);

        const tbody = $('#' + tableId);
        tbody.empty();
        let count = 0;

        players.forEach(function (player, index) {
            const pid = player.pid;
            const pname = player.pname;

            // --- NEW: Logic to pre-check boxes ---
            let player_checked = "";
            let is_playing_checked = "";
            
            // Check if this player is in the existing squad
            if (existing_squad && existing_squad[pid]) { 
                player_checked = "checked"; // Player is in the squad
                if (existing_squad[pid].is_playing) {
                    is_playing_checked = "checked"; // Player is also in the playing 11
                }
            }
            // --- End new logic ---

            const row = `
            <tr>
                <td>
                    <input type="checkbox" name="${tableId}_player" 
                           id="${tableId}_player_${count}" 
                           value="${pid}" ${player_checked}> </td>
                <td>
                    <input type="checkbox" name="${tableId}_is_playing" 
                           id="${tableId}_is_playing_${count}" ${is_playing_checked}> </td>
                <td>
                    <label for="${tableId}_player_${count}">${pname}</label>
                </td>
            </tr>
        `;

            tbody.append(row);
            count += 1;
        });
    }

    // --- MODIFIED: chksave() ---
    function chksave() {
        let msave = "S";
        var mid = document.getElementById("match").value;
        var mode = document.querySelector('input[name="squadMode"]:checked').value; // NEW: Get current mode
        
        if (!mid) {
            alert("Please select a match.");
            return;
        }

        var playerlist = [];

        [
            { tableId: 'team1_players', team: team1 },
            { tableId: 'team2_players', team: team2 }
        ].forEach(function (tableInfo) {
            const table = document.getElementById(tableInfo.tableId);
            const rows = table.getElementsByTagName("tr");

            for (let i = 0; i < rows.length; i++) {
                const row = rows[i];
                const inputs = row.getElementsByTagName("input");
                const label = row.getElementsByTagName("label")[0];

                let selected = false;
                let pid = null; // We don't need pid for the save, but good to have
                let is_playing = false;
                let pname = label ? label.innerText : "";

                for (let input of inputs) {
                    if (input.name.includes("_player") && input.checked) {
                        selected = true;
                        pid = input.value;
                    }
                    if (input.name.includes("_is_playing")) {
                        is_playing = input.checked;
                    }
                }

                // Only add to list if the player is selected
                if (selected) {
                    playerlist.push([is_playing, pname, tableInfo.team]);
                }
            }
        });

        console.log("Prepared Player List:", playerlist);
        if (playerlist.length === 0) {
            alert("Please select at least one player.");
            return;
        }

        $.ajax({
            url: 'match_squad',
            type: 'POST',
            headers: { 'X-CSRFToken': csrftoken },
            data: {
                "mid": mid,
                "msave": msave,
                "players": JSON.stringify(playerlist),
                "mode": mode // NEW: Send the mode
            },
            success: function (response) {
                if (response.error) {
                    alert(response.error);
                } else if (response.message) {
                    alert(response.message);
                    window.location.href = '/admin_dashboard'; // Or wherever you want to redirect
                } else {
                    alert("Unexpected response");
                }
            },
            error: function (xhr, status, error) {
                 // Improved error logging
                 let errorMsg = "An unknown error occurred while saving.";
                if (xhr.responseJSON && xhr.responseJSON.error) {
                    errorMsg = xhr.responseJSON.error;
                } else {
                    errorMsg = xhr.responseText;
                }
                alert("Error: " + errorMsg);
                console.error(xhr.responseText);
            }
        });
    }

</script>
{% endblock 'main' %}