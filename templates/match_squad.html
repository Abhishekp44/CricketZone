{% extends 'base.html' %}
{% load static %}
{% block 'main' %}
{% csrf_token %}
<style>
    /* Your style for #match remains unchanged */
    #match {
        white-space: nowrap;
        overflow: hidden; 
        text-overflow: ellipsis;
        width: 100%; 
    }

    /* --- UPDATED STYLES --- */
    
    /* This makes the row clickable (unchanged) */
    .player-row {
        cursor: pointer;
        transition: background-color 0.1s ease-in-out;
    }

    /* * THE FIX:
     * 1. We apply styles to the <td> (cells) *within* the row.
     * 2. We use !important to override the 'custom-table' styles.
    */
    
    /* State 1: Yellow (for "In Squad") */
    .player-row.squad-selected td {
        background-color: #bba000 !important; /* Darker yellow */
        color: #fff !important; /* Ensure text is readable */
    }
    
    /* State 2: Green (for "Playing 11") */
    .player-row.playing-selected td {
        background-color: #008000 !important; /* Dark green */
        color: #fff !important; /* Ensure text is readable */
    }
    
    /* We must also update the :hover style to target the <td> */
    .player-row:hover td {
        background-color: #444 !important; 
    }
    
    /* Hide the old "Select" and "Is Playing" columns (unchanged) */
    .col-select, .col-playing {
        display: none;
    }
    /* --- END UPDATED STYLES --- */
</style>

<div class="site-section bg-dark">
    <div class="container">
        <div class="row mt-3 justify-content-evenly">
            <h1 id="scorecard-entry-header" style="margin-top: 50px;">Match Squad Selection</h1>
        </div>

        <form id="scorecardForm" method="POST" action="{% url 'match_squad' %}">
            {% csrf_token %}
            
            <div class="row mt-3 justify-content-center">
                <div class="col-12 col-lg-8 col-xl-6 text-center">
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="squadMode" id="modeAdd" value="add" checked>
                        <label class="form-check-label" for="modeAdd">Add New Squad</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="squadMode" id="modeUpdate" value="update">
                        <label class="form-check-label" for="modeUpdate">Update Existing Squad</label>
                    </div>
                </div>
            </div>

            <div class="row mt-3 justify-content-center">
                <div class="col-12 col-lg-8 col-xl-6">
                    <label for="match">Select Match</label>
                    <select class="form-select" name="match" id="match" required onchange="chkmatch()">
                        </select>
                </div>
            </div>

            <div class="row w-100 mt-4">
                <div class="col-md-6">
                    <h3 id="t1_name">Team 1 Players</h3>
                    <table class="table custom-table">
                        <thead>
                            <tr>
                                <th class="col-select">Select</th>
                                <th class="col-playing">Is Playing</th>
                                <th>Player Name</th>
                            </tr>
                        </thead>
                        <tbody id="team1_players"></tbody>
                    </table>
                </div>

                <div class="col-md-6">
                    <h3 id="t2_name">Team 2 Players</h3>
                    <table class="table custom-table">
                        <thead>
                            <tr>
                                <th class="col-select">Select</th>
                                <th class="col-playing">Is Playing</th>
                                <th>Player Name</th>
                            </tr>
                        </thead>
                        <tbody id="team2_players"></tbody>
                    </table>
                </div>
            </div>

            <div class="mt-3">
                <button type="button" class="btn btn-primary" onclick="chksave()">Save Squad</button>
            </div>
        </form>

    </div>
</div>
<script>
    // --- Storing matches from Django context (unchanged) ---
    const inactiveMatches = [
        {% for match in inactive_matches %}
        { id: '{{ match.match_id }}', text: '{{ match }}' },
        {% endfor %}
    ];
    const activeMatches = [
        {% for match in active_matches %}
        { id: '{{ match.match_id }}', text: '{{ match }}' },
        {% endfor %}
    ];

    let team1, team2;
    const csrftoken = getCookie('csrftoken'); 

    // --- Run on page load (unchanged) ---
    document.addEventListener('DOMContentLoaded', function() {
        updateMatchDropdown();
        document.getElementById('modeAdd').addEventListener('change', updateMatchDropdown);
        document.getElementById('modeUpdate').addEventListener('change', updateMatchDropdown);
    });

    // --- Function to update dropdown based on mode (unchanged) ---
    function updateMatchDropdown() {
        const mode = document.querySelector('input[name="squadMode"]:checked').value;
        const matchSelect = document.getElementById('match');
        const matches = (mode === 'add') ? inactiveMatches : activeMatches;

        matchSelect.innerHTML = '';
        $('#team1_players').empty();
        $('#team2_players').empty();
        $('#t1_name').text('Team 1 Players');
        $('#t2_name').text('Team 2 Players');
        matchSelect.add(new Option('---Select Match---', ''));
        matches.forEach(function(match) {
            matchSelect.add(new Option(match.text, match.id));
        });
    }

    // --- getCookie function (unchanged) ---
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // --- chkmatch() (unchanged, still calls the modified fillPlayerTable) ---
    function chkmatch() {
        var mid = document.getElementById("match").value;
        
        if (!mid) { 
            $('#team1_players').empty();
            $('#team2_players').empty();
            $('#t1_name').text('Team 1 Players');
            $('#t2_name').text('Team 2 Players');
            return;
        }

        var mode = document.querySelector('input[name="squadMode"]:checked').value;
        var chkmatch = 'chkmatch';

        $.ajax({
            url: 'match_squad',
            type: 'POST',
            headers: { 'X-CSRFToken': csrftoken },
            data: { "mid": mid, "chkmatch": chkmatch, "mode": mode },
            success: function (response) {
                if (response.error) {
                    alert(response.error);
                    document.getElementById('match').value = '';
                    $('#team1_players').empty();
                    $('#team2_players').empty();
                    $('#t1_name').text('Team 1 Players');
                    $('#t2_name').text('Team 2 Players');
                }
                else {
                    teams = response["teams"];
                    t1_players = response["team1_players"];
                    t2_players = response["team2_players"];
                    let existing_squad = response.existing_squad || {}; 
                    console.log("Existing Squad:", existing_squad);

                    team1 = teams[0][1];
                    team2 = teams[1][1];

                    document.getElementById("t1_name").innerText = `${team1} Players`;
                    document.getElementById("t2_name").innerText = `${team2} Players`;

                    let table1 = document.getElementById("team1_players").id;
                    fillPlayerTable(table1, t1_players, existing_squad) 
                    let table2 = document.getElementById("team2_players").id;
                    fillPlayerTable(table2, t2_players, existing_squad)
                }
            },
            error: function (xhr, status, error) {
                let errorMsg = "An unknown error occurred.";
                if (xhr.responseJSON && xhr.responseJSON.error) {
                    errorMsg = xhr.responseJSON.error;
                } else if (xhr.responseText) {
                    try {
                        errorMsg = JSON.parse(xhr.responseText).error;
                    } catch (e) {
                        errorMsg = xhr.responseText;
                    }
                }
                alert("Error: " + errorMsg);
                console.error(xhr.responseText);
            }
        });
    }

    // --- *** NEW FUNCTION *** ---
    // Handles the 3-state click logic
    function togglePlayerState(row) {
        // Find the hidden checkboxes within this row
        const playerCheckbox = row.querySelector('input[name*="_player"]');
        const playingCheckbox = row.querySelector('input[name*="_is_playing"]');

        const isSelected = playerCheckbox.checked;
        const isPlaying = playingCheckbox.checked;

        if (!isSelected && !isPlaying) {
            // State 0 (None) -> State 1 (Squad)
            playerCheckbox.checked = true;
            playingCheckbox.checked = false;
            row.classList.remove('playing-selected');
            row.classList.add('squad-selected');
        } else if (isSelected && !isPlaying) {
            // State 1 (Squad) -> State 2 (Playing 11)
            playerCheckbox.checked = true;
            playingCheckbox.checked = true;
            row.classList.remove('squad-selected');
            row.classList.add('playing-selected');
        } else { 
            // State 2 (Playing 11) -> State 0 (None)
            playerCheckbox.checked = false;
            playingCheckbox.checked = false;
            row.classList.remove('playing-selected');
            row.classList.remove('squad-selected');
        }
    }

    // --- *** MODIFIED: fillPlayerTable() *** ---
    // Now builds clickable rows and sets initial class
    function fillPlayerTable(tableId, players, existing_squad) {
        console.log("Filling table:", tableId, players);

        const tbody = $('#' + tableId);
        tbody.empty();
        let count = 0;

        players.forEach(function (player, index) {
            const pid = player.pid;
            const pname = player.pname;

            // Determine initial state from existing_squad
            let player_checked_str = "";
            let is_playing_checked_str = "";
            let row_class = ""; // State 0 (None)
            
            if (existing_squad && existing_squad[pid]) { 
                player_checked_str = "checked";
                if (existing_squad[pid].is_playing) {
                    is_playing_checked_str = "checked"; 
                    row_class = "playing-selected"; // State 2 (Green)
                } else {
                    row_class = "squad-selected"; // State 1 (Yellow)
                }
            }

            // MODIFIED: This row is now clickable and has classes
            const row = `
            <tr class="player-row ${row_class}" onclick="togglePlayerState(this)">
                <td class="col-select">
                    <input type="checkbox" name="${tableId}_player" 
                           id="${tableId}_player_${count}" 
                           value="${pid}" ${player_checked_str}> 
                </td>
                <td class="col-playing">
                    <input type="checkbox" name="${tableId}_is_playing" 
                           id="${tableId}_is_playing_${count}" ${is_playing_checked_str}> 
                </td>
                <td>
                    <label for="${tableId}_player_${count}">${pname}</label>
                </td>
            </tr>
            `;

            tbody.append(row);
            count += 1;
        });
    }

    // --- *** MODIFIED: chksave() *** ---
    // Now sends Player ID (pid) instead of Player Name (pname)
    function chksave() {
        let msave = "S";
        var mid = document.getElementById("match").value;
        var mode = document.querySelector('input[name="squadMode"]:checked').value;
        
        if (!mid) {
            alert("Please select a match.");
            return;
        }

        var playerlist = [];

        [
            { tableId: 'team1_players', team: team1 },
            { tableId: 'team2_players', team: team2 }
        ].forEach(function (tableInfo) {
            const table = document.getElementById(tableInfo.tableId);
            const rows = table.getElementsByTagName("tr");

            for (let i = 0; i < rows.length; i++) {
                const row = rows[i];
                
                // --- START OF FIX ---
                // Use specific "ends-with" attribute selectors [$] to find the inputs.
                // This is much safer than input.name.includes()
                const playerCheckbox = row.querySelector('input[name$="_player"]');
                const playingCheckbox = row.querySelector('input[name$="_is_playing"]');
                
                // If checkboxes aren't found (e.g., header row), skip
                if (!playerCheckbox || !playingCheckbox) continue; 

                const selected = playerCheckbox.checked;
                const is_playing = playingCheckbox.checked;
                const pid = playerCheckbox.value; // Get value from the *player* checkbox
                // --- END OF FIX ---

                // Only add to list if the player is selected (unchanged)
                if (selected) {
                    playerlist.push([is_playing, pid, tableInfo.team]);
                }
            }
        });

        console.log("Prepared Player List (using PID):", playerlist);
        if (playerlist.length === 0) {
            alert("Please select at least one player.");
            return;
        }

        // --- AJAX call is unchanged ---
        $.ajax({
            url: 'match_squad',
            type: 'POST',
            headers: { 'X-CSRFToken': csrftoken },
            data: {
                "mid": mid,
                "msave": msave,
                "players": JSON.stringify(playerlist),
                "mode": mode
            },
            success: function (response) {
                if (response.error) {
                    alert(response.error);
                } else if (response.message) {
                    alert(response.message);
                    window.location.href = '/admin_dashboard'; 
                } else {
                    alert("Unexpected response");
                }
            },
            error: function (xhr, status, error) {
               let errorMsg = "An unknown error occurred while saving.";
                if (xhr.responseJSON && xhr.responseJSON.error) {
                    errorMsg = xhr.responseJSON.error;
                } else {
                    errorMsg = xhr.responseText;
                }
                alert("Error: " + errorMsg);
                console.error(xhr.responseText);
            }
        });
    }
</script>
{% endblock 'main' %}