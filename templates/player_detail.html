{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}

{% block 'main' %}
<style>
    /* --- Main Profile Card Styles (Mostly Unchanged) --- */
    .player-profile-section { background-color: #1a1a1a; padding: 40px 0; color: #fff; }
    .profile-card {
        background-color: #2c2c2c; border-radius: 15px; padding: 30px;
        display: flex; align-items: center; gap: 30px; flex-wrap: wrap;
    }
    .profile-image {
        width: 150px; height: 150px; border-radius: 50%; object-fit: cover;
        border: 4px solid #ee1e46;
    }
    .profile-info h1 { margin: 0; font-size: 2.5rem; font-weight: bold; }
    .profile-info .jersey-number { font-size: 1.5rem; color: #ee1e46; font-weight: bold; }
    .profile-info .player-role { font-size: 1.2rem; color: #ccc; margin-top: 5px; }
    .team-list { list-style: none; padding: 0; margin-top: 15px; display: flex; flex-wrap: wrap; gap: 10px; }
    .team-item { display: flex; align-items: center; gap: 10px; background-color: #444; padding: 6px 12px; border-radius: 25px; }
    .team-logo-small { width: 28px; height: 28px; border-radius: 50%; object-fit: cover; }

    /* --- New Stats Section UI --- */
    .stats-section { padding: 40px 0; background-color: #111; }

    /* Dropdown Selector */
    .tournament-selector-wrapper { margin-bottom: 2rem; }
    .form-select {
        background-color: #2c2c2c;
        color: #fff;
        border: 1px solid #555;
    }
    .form-select:focus {
        border-color: #ee1e46;
        box-shadow: 0 0 0 0.25rem rgba(238, 30, 70, 0.5);
    }

    /* KPI Stat Cards */
    .kpi-card {
        background-color: #2c2c2c;
        padding: 20px;
        border-radius: 10px;
        text-align: center;
        border-left: 5px solid #ee1e46;
        margin-bottom: 1rem;
    }
    .kpi-card .kpi-value {
        font-size: 2.2rem;
        font-weight: bold;
        color: #fff;
        line-height: 1;
    }
    .kpi-card .kpi-label {
        font-size: 0.9rem;
        color: #aaa;
        margin-top: 5px;
        text-transform: uppercase;
    }

    /* Stat Breakdown Sections */
    .stats-breakdown {
        background-color: #2c2c2c;
        padding: 25px;
        border-radius: 10px;
    }
    .stats-breakdown h5 {
        color: #ee1e46;
        font-weight: bold;
        margin-bottom: 1.5rem;
        border-bottom: 2px solid #444;
        padding-bottom: 10px;
    }
    .stats-breakdown .list-group-item {
        background-color: transparent;
        color: #ccc;
        border-color: #444;
        display: flex;
        justify-content: space-between;
        padding: 0.8rem 0;
    }
    .stats-breakdown .list-group-item strong {
        color: #fff;
        font-weight: 600;
    }
</style>

<div class="player-profile-section" style="padding-top: 100px;">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <div class="profile-card">
                    <img src="{% if player.pimage %}{{ player.pimage.url }}{% else %}https://placehold.co/150x150/FFFFFF/1a1a1a?text={{ player.pname|slice:':1' }}{% endif %}" alt="{{ player.pname }}" class="profile-image">
                    <div class="profile-info">
                        <h1>{{ player.pname }}</h1>
                        <p class="jersey-number">Jersey No: {{ player.pjr_no }}</p>
                        <p class="player-role">{{ player.prole }} | {{ player.parm }}</p>
                        <div class="team-list">
                            {% for team in teams %}<div class="team-item">{% if team.timage %}<img src="{{ team.timage.url }}" alt="{{ team.tname }}" class="team-logo-small">{% endif %}<span>{{ team.tname }}</span></div>{% empty %}<span>No Teams Assigned</span>{% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="stats-section">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-10">

                {% if tournament_stats %}
                    <div class="tournament-selector-wrapper">
                        <label for="tournamentSelector" class="form-label text-light mb-2">Select Tournament:</label>
                        <select class="form-select" id="tournamentSelector">
                            {% for stats in tournament_stats %}
                                <option value="tourn-{{ stats.tournament.id }}">{{ stats.tournament.name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div id="stats-container">
                        {% for stats in tournament_stats %}
                            <div class="tournament-stats-box" id="tourn-{{ stats.tournament.id }}" {% if not forloop.first %}style="display: none;"{% endif %}>

                                <div class="row mb-4">
                                    <div class="col-md-3 col-6"><div class="kpi-card"><div class="kpi-value">{{ stats.batting.runs|default:0 }}</div><div class="kpi-label">Total Runs</div></div></div>
                                    <div class="col-md-3 col-6"><div class="kpi-card"><div class="kpi-value">{{ stats.batting.highest_score|default:0 }}{% if stats.batting.hs_not_out %}*{% endif %}</div><div class="kpi-label">Highest Score</div></div></div>
                                    <div class="col-md-3 col-6"><div class="kpi-card"><div class="kpi-value">{{ stats.bowling.wickets|default:0 }}</div><div class="kpi-label">Total Wickets</div></div></div>
                                    <div class="col-md-3 col-6"><div class="kpi-card"><div class="kpi-value">{{ stats.bowling.bbi|default:"-" }}</div><div class="kpi-label">Best Bowling</div></div></div>
                                </div>

                                <div class="row">
                                    <div class="col-lg-6 mb-4 mb-lg-0">
                                        <div class="stats-breakdown">
                                            <h5><i class="fa-solid fa-person-running me-2"></i> Batting Breakdown</h5>
                                            {% if stats.batting.innings > 0 %}
                                            <ul class="list-group list-group-flush">
                                                <li class="list-group-item"><span>Matches</span> <strong>{{ stats.batting.matches }}</strong></li>
                                                <li class="list-group-item"><span>Innings</span> <strong>{{ stats.batting.innings }}</strong></li>
                                                <li class="list-group-item"><span>Average</span> <strong>{{ stats.batting.average }}</strong></li>
                                                <li class="list-group-item"><span>Strike Rate</span> <strong>{{ stats.batting.strike_rate }}</strong></li>
                                                <li class="list-group-item"><span>100s / 50s</span> <strong>{{ stats.batting.hundreds }} / {{ stats.batting.fifties }}</strong></li>
                                                <li class="list-group-item"><span>Fours / Sixes</span> <strong>{{ stats.batting.fours }} / {{ stats.batting.sixes }}</strong></li>
                                            </ul>
                                            {% else %}
                                            <p class="text-muted">Did not bat in this tournament.</p>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="col-lg-6">
                                        <div class="stats-breakdown">
                                            <h5><i class="fa-solid fa-baseball-bat-ball me-2"></i> Bowling Breakdown</h5>
                                            {% if stats.bowling.innings > 0 %}
                                            <ul class="list-group list-group-flush">
                                                <li class="list-group-item"><span>Matches</span> <strong>{{ stats.bowling.matches }}</strong></li>
                                                <li class="list-group-item"><span>Innings</span> <strong>{{ stats.bowling.innings }}</strong></li>
                                                <li class="list-group-item"><span>Average</span> <strong>{{ stats.bowling.average }}</strong></li>
                                                <li class="list-group-item"><span>Economy</span> <strong>{{ stats.bowling.economy }}</strong></li>
                                                <li class="list-group-item"><span>Strike Rate</span> <strong>{{ stats.bowling.strike_rate }}</strong></li>
                                                <li class="list-group-item"><span>Maidens</span> <strong>{{ stats.bowling.maidens }}</strong></li>
                                            </ul>
                                            {% else %}
                                            <p class="text-muted">Did not bowl in this tournament.</p>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>

                {% else %}
                    <div class="text-center"><h3 class="text-white">No tournament stats available for this player yet.</h3></div>
                {% endif %}

                <div class="row justify-content-center mt-5">
                    <div class="col-md-6 text-center">
                        <a href="javascript:history.back()" class="btn btn-outline-light">&larr; Go Back</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<script>
    document.addEventListener('DOMContentLoaded', function () {
        const tournamentSelector = document.getElementById('tournamentSelector');

        // Only run script if the selector exists
        if (tournamentSelector) {
            tournamentSelector.addEventListener('change', function() {
                // Get the ID of the selected tournament from the dropdown's value
                const selectedId = this.value;

                // Get all the individual tournament stat boxes
                const allStatBoxes = document.querySelectorAll('.tournament-stats-box');

                // Hide all stat boxes first
                allStatBoxes.forEach(box => {
                    box.style.display = 'none';
                });

                // Find the one stat box that matches the selected ID and show it
                const boxToShow = document.getElementById(selectedId);
                if (boxToShow) {
                    boxToShow.style.display = 'block';
                }
            });
        }
    });

</script>
{% endblock 'main' %}